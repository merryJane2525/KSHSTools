generator client {
  provider   = "prisma-client-js"
  // 드라이버 어댑터(@prisma/adapter-better-sqlite3)를 사용하는
  // Prisma v7 "client" 엔진 아키텍처를 사용합니다.
  engineType = "client"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  USER
  OPERATOR
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
}

enum PostStatus {
  OPEN
  RESOLVED
}

enum MentionTargetType {
  POST
  COMMENT
}

enum NotificationType {
  ASSIGNED
  MENTIONED
  COMMENTED
  SYSTEM
  OPERATOR_REQUEST   // 오퍼레이터 지정 예약 요청
  OPERATOR_APPROVED  // 오퍼레이터 승인
  OPERATOR_REJECTED  // 오퍼레이터 거절
  RESERVATION_CANCELED
}

enum ReportTargetType {
  POST
  COMMENT
}

enum ReportReason {
  SPAM
  ABUSE
  PRIVACY
  OTHER
}

enum ReportStatus {
  OPEN
  IN_REVIEW
  RESOLVED
  REJECTED
}

enum ReservationStatus {
  PENDING   // 대기 (오퍼레이터 승인 전)
  APPROVED  // 승인됨 (시간대 확정)
}

enum OperatorStatus {
  NONE      // 오퍼레이터 없이 예약
  REQUESTED // 오퍼레이터 승인 대기
  APPROVED  // 오퍼레이터 승인 완료
  REJECTED  // 오퍼레이터 거절
  CANCELED  // 예약 취소 등으로 요청 종료
}

enum OperatorWorkLogStatus {
  SCHEDULED  // 예정
  COMPLETED  // 완료
  CANCELED   // 취소
  ADJUSTED   // 조정됨
}

enum SearchDocumentType {
  equipment
  manual
  qa
}

model User {
  id              String     @id @default(uuid())
  email           String     @unique
  passwordHash    String
  username        String     @unique
  studentNumber   String?    // 학번 (예약 신청 시 표시/미리채움)
  role            UserRole   @default(USER)
  status          UserStatus @default(ACTIVE)
  emailVerifiedAt DateTime?

  posts           Post[]
  comments        Comment[]
  reservations    Reservation[]
  operatorReservationRequests Reservation[] @relation("ReservationOperator")

  assignments          PostAssignment[] @relation("OperatorAssignments")
  createdAssignments   PostAssignment[] @relation("AssignmentCreator")

  mentionsReceived Mention[] @relation("MentionsReceived")
  mentionsSent     Mention[] @relation("MentionsSent")

  notifications        Notification[] @relation("NotificationRecipient")
  notificationsActed   Notification[] @relation("NotificationActor")

  pushSubscriptions PushSubscription[]

  operatorWorkLogs  OperatorWorkLog[] @relation("WorkLogOperator")
  requesterWorkLogs OperatorWorkLog[]  @relation("WorkLogRequester")

  reportsFiled    Report[] @relation("ReportsFiled")
  auditLogs       AuditLog[] @relation("AuditActor")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Equipment {
  id           String  @id @default(uuid())
  name         String  @unique
  slug         String  @unique
  description  String? // 예약 카드/상세용 간단한 설명
  isActive     Boolean @default(true)
  manual       String? // 사용 메뉴얼 (마크다운 또는 HTML)
  manualImages Json?   // 메뉴얼 이미지 데이터 배열 (Base64)

  posts     Post[]
  reservations Reservation[]
  workLogs  OperatorWorkLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Reservation {
  id            String             @id @default(uuid())
  equipmentId   String
  userId        String
  status        ReservationStatus  @default(PENDING)

  title         String?            // 예약 제목
  studentNumber String?            // 예약 시 입력한 학번
  startAt       DateTime
  endAt         DateTime
  note          String?            // 설명

  cancelledAt DateTime?

  operatorId         String?         // 지정된 오퍼레이터
  operatorStatus     OperatorStatus  @default(NONE)
  operatorResponseAt DateTime?
  operatorNote       String?         // 승인/거절 코멘트(거절 사유)

  equipment   Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  operator    User?     @relation("ReservationOperator", fields: [operatorId], references: [id], onDelete: SetNull)

  workLog     OperatorWorkLog?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([equipmentId, startAt])
  @@index([equipmentId, endAt])
  @@index([equipmentId, status])
  @@index([userId, startAt])
  @@index([operatorId, operatorStatus])
}

model Post {
  id          String     @id @default(uuid())
  title       String
  body        String
  imageUrls   Json?      // 이미지 URL 배열 (Base64 또는 외부 URL)
  authorId    String
  equipmentId String
  status      PostStatus @default(OPEN)

  author      User      @relation(fields: [authorId], references: [id])
  equipment   Equipment @relation(fields: [equipmentId], references: [id])

  comments    Comment[]
  assignments PostAssignment[]
  mentions    Mention[]
  notifications Notification[]

  deletedAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([equipmentId, createdAt])
  @@index([authorId, createdAt])
}

model Comment {
  id        String   @id @default(uuid())
  postId    String
  authorId  String
  body      String

  post      Post     @relation(fields: [postId], references: [id])
  author    User     @relation(fields: [authorId], references: [id])

  notifications Notification[]

  deletedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([postId, createdAt])
  @@index([authorId, createdAt])
}

model PostAssignment {
  id          String   @id @default(uuid())
  postId      String
  operatorId  String
  createdById String
  createdAt   DateTime @default(now())

  post        Post @relation(fields: [postId], references: [id])
  operator    User @relation("OperatorAssignments", fields: [operatorId], references: [id])
  createdBy   User @relation("AssignmentCreator", fields: [createdById], references: [id])

  @@unique([postId, operatorId])
  @@index([operatorId, createdAt])
  @@index([postId])
}

model Mention {
  id              String            @id @default(uuid())
  targetType      MentionTargetType
  targetId        String
  postId          String
  mentionedUserId String
  mentionedById   String
  createdAt       DateTime @default(now())

  post            Post @relation(fields: [postId], references: [id])

  mentionedUser   User @relation("MentionsReceived", fields: [mentionedUserId], references: [id])
  mentionedBy     User @relation("MentionsSent", fields: [mentionedById], references: [id])

  @@unique([targetType, targetId, mentionedUserId])
  @@index([mentionedUserId, createdAt])
  @@index([postId, createdAt])
}

model Notification {
  id            String           @id @default(uuid())
  userId        String
  type          NotificationType
  actorId       String?
  postId        String?
  commentId     String?
  reservationId String?

  title     String
  body      String
  linkUrl   String

  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())

  dedupKey  String?          @unique

  recipient User             @relation("NotificationRecipient", fields: [userId], references: [id])
  actor     User?            @relation("NotificationActor", fields: [actorId], references: [id])
  post      Post?            @relation(fields: [postId], references: [id])
  comment   Comment?         @relation(fields: [commentId], references: [id])

  @@index([userId, isRead, createdAt])
  @@index([userId, createdAt])
  @@index([reservationId])
}

model OperatorWorkLog {
  id             String                @id @default(uuid())
  reservationId  String                @unique
  operatorId     String
  equipmentId    String
  userId         String                // 예약자
  startAt        DateTime
  endAt          DateTime
  workedMinutes  Int                   // (end_at - start_at) 분
  status         OperatorWorkLogStatus @default(SCHEDULED)

  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  operator    User        @relation("WorkLogOperator", fields: [operatorId], references: [id], onDelete: Cascade)
  equipment   Equipment   @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  user        User        @relation("WorkLogRequester", fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([operatorId, startAt])
  @@index([operatorId, status])
}

model Report {
  id         String           @id @default(uuid())
  reporterId String
  targetType ReportTargetType
  targetId   String
  reason     ReportReason
  detail     String?
  status     ReportStatus     @default(OPEN)
  adminNote  String?

  reporter   User             @relation("ReportsFiled", fields: [reporterId], references: [id])

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([reporterId, targetType, targetId])
  @@index([status, createdAt])
}

model AuditLog {
  id         String   @id @default(uuid())
  actorId    String?
  action     String
  targetType String
  targetId   String?
  meta       Json?
  createdAt  DateTime @default(now())

  actor      User? @relation("AuditActor", fields: [actorId], references: [id])

  @@index([action, createdAt])
  @@index([actorId, createdAt])
}

model SearchDocument {
  id          String              @id @default(uuid())
  type        SearchDocumentType
  sourceId    String
  equipmentId String?
  title       String
  content     String
  tags        String[]            @default([])
  url         String
  updatedAt   DateTime            @updatedAt
  popularity  Int                 @default(0)

  @@unique([type, sourceId])
  @@index([type])
  @@index([equipmentId])
  @@index([updatedAt])
}
